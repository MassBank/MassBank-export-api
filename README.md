# MassBank-export-api

A REST interface to export MassBank records to other formats.

This server was generated by the [OpenAPI Generator](https://openapi-generator.tech) project and uses
Spring Boot. It uses the RecordParserDefinition from the original
[MassBank project](https://github.com/MassBank/MassBank-web).

## Requirements

- Java 21
- Spring Boot 3.5
- maven
- PostgreSQL (tested on version 17)

## Configuration

### MassBank Data

This microservice is configured with environment variables. It requires a
directory with the [MassBank-data](https://github.com/MassBank/MassBank-data)
release. This directory needs to be configured in the environment variable
`MB_DATA_DIRECTORY`.

```bash
git clone https://github.com/MassBank/MassBank-data.git
export MB_DATA_DIRECTORY="./MassBank-data"
```

### CORS

To configure CORS you can set the environment variable `CORS_ALLOWED_ORIGINS`.

```bash
export CORS_ALLOWED_ORIGINS=http://localhost:3000
```

### Using a Reverse Proxy

To make the Swagger UI work behind a reverse proxy one must configure
some X-Forward RequestHeader as descibed [here](https://springdoc.org/faq.html#_how_can_i_deploy_springdoc_openapi_starter_webmvc_ui_behind_a_reverse_proxy).
Here is an example for Apache:

```bash
RequestHeader set X-Forwarded-Prefix "/MassBank-export"
RequestHeader set X-Forwarded-Proto https
RequestHeader set X-Forwarded-Port 443
```

To make this work with a K8s nginx Ingress one needs to enable the property

```bash
use-forwarded-headers true
```

in the ingress-nginx-controller ConfigMap.
The application context path can be configured with the environment variable CONTEXT_PATH.
If not set / is used by default.

### PostgreSQL

Make sure to have a [PostgreSQL](https://www.postgresql.org) server installed and running on your system. The MassBank data will be stored there.

By default, the export service expects the PostgreSQL service running at _localhost_ with port 5432 and the database _postgres_. Default user is _postgres_ and password is _postgres_.

## Build and Run

Run the _run-cmd.sh_ script to let build the JAR file in _target_ directory and to start the export api service with all pre-configured variables.

```bash
sh run-cmd.sh
```

## Run with Docker

### Build and Run

Start the _run-docker.sh_ script to let build and run the server in a Docker container with default settings.

```bash
sh run-docker.sh
```

### Use Pre-built Container

Pre-built Docker images are available from
[quay.io/massbank/massbank-export-api](https://quay.io/repository/massbank/massbank-export-api).
The fastest way to get things running is:

```bash
# Start up a container in detached mode
docker run -d -p 8080:8080 \
-v $MB_DATA_DIRECTORY:/MassBank-data \
quay.io/massbank/massbank-export-api:latest
```

## Usage

For a description of how to use the api browse to the [Swagger UI](http://localhost:8080/swagger-ui/index.html).

For example, to download all MassBank records in one zip file use the following command:

```bash
curl -X 'POST' \
  'http://localhost:8080/convert' \
  -H 'accept: application/zip' \
  -H 'Content-Type: application/json' \
  -d '{
  "format": "massbank"
}' --output records.zip
```

Or, for example, to get a record's raw text use the following command:

```bash
curl -X 'GET' \
  'http://localhost:8080/rawtext/MSBNK-IPB_Halle-PB001341' \
  -H 'accept: text/plain' \
  -H 'Content-Type: application/json'
```
